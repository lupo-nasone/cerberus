"use client";
import { FormEvent, useState } from "react";
import Link from "next/link";
import Header from "./components/Header";
import Hero from "./components/Hero";
import HowItWorks from "./components/HowItWorks";
import ServiceCard from "./components/ServiceCard";
import Testimonials from "./components/Testimonials";
import Footer from "./components/Footer";
import Reveal from "./components/Reveal";
import { useLocale } from "./lib/LanguageProvider";

export default function Home() {
  const { t } = useLocale();
  const [leadSuccess, setLeadSuccess] = useState(false);
  const clients = (t("home.clientsList") as unknown) as string[];

  const services = [
    {
      title: t("services.items.scadenziario.title"),
      desc: t("services.items.scadenziario.desc"),
      image: "https://images.unsplash.com/photo-1523365280197-f1783db9fe62?auto=format&fit=crop&w=600&q=80"
    },
    {
      title: t("services.items.assistenza.title"),
      desc: t("services.items.assistenza.desc"),
      image: "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=600&q=80"
    },
    {
      title: t("services.items.consulenza.title"),
      desc: t("services.items.consulenza.desc"),
      image: "https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&w=600&q=80"
    },
    {
      title: t("services.items.formazione.title"),
      desc: t("services.items.formazione.desc"),
      image: "https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?auto=format&fit=crop&w=600&q=80"
    }
  ];

  const highlightBullets = [
    {
      title: t("services.items.scadenziario.title"),
      desc: t("services.items.scadenziario.desc")
    },
    {
      title: t("services.items.assistenza.title"),
      desc: t("services.items.assistenza.desc")
    },
    {
      title: t("services.items.consulenza.title"),
      desc: t("services.items.consulenza.desc")
    }
  ];

  const metrics = [
    t("home.metric1") as string,
    t("home.metric2") as string,
    t("home.metric3") as string
  ];

  const serviceCta = t("services.learnMore");
  const fallbackClients = ["Azienda A", "Azienda B", "Azienda C", "Azienda D"];
  const clientsList = clients && clients.length ? clients : fallbackClients;
  const marqueeClients = [...clientsList, ...clientsList];

  const renderMetric = (metric: string) => {
    const match = metric.match(/(\d+[\w%]*)/);
    if (!match) {
      return metric;
    }
    const value = match[0];
    const index = metric.indexOf(value);
    return (
      <>
        {metric.slice(0, index)}
        <span className="metric-value">{value}</span>
        {metric.slice(index + value.length)}
      </>
    );
  };

  type SubscriptionContent = {
    eyebrow: string;
    title: string;
    desc: string;
    bullets: string[];
    cta: string;
  };

  type PromiseContent = {
    eyebrow: string;
    title: string;
    bulletTitle: string;
    paragraphs: string[];
    bullets: string[];
  };

  type LeadField = {
    name: string;
    label: string;
    type?: string;
    placeholder?: string;
    fullWidth?: boolean;
    required?: boolean;
  };

  type ResourceArticle = {
    title: string;
    href: string;
    category?: string;
    excerpt?: string;
  };

  type ResourcesContent = {
    eyebrow: string;
    title: string;
    lead: string;
    leadMagnet: {
      title: string;
      subtitle: string;
      formTitle: string;
      privacy: string;
      cta: string;
      success: string;
      fields: LeadField[];
    };
    blog: {
      title: string;
      subtitle: string;
      cta: string;
      postLinkLabel: string;
      ctaHref: string;
      posts: ResourceArticle[];
    };
  };

  type FinalCtaContent = {
    eyebrow: string;
    title: string;
    subtitle: string;
    bullets: string[];
    cta: string;
    ctaHref: string;
  };

  const subscriptionRaw = t("subscription") as any;
  const subscription: SubscriptionContent = {
    eyebrow: typeof subscriptionRaw?.eyebrow === "string" ? subscriptionRaw.eyebrow : "Un unico canone",
    title: typeof subscriptionRaw?.title === "string" ? subscriptionRaw.title : "Abbonamento Verifica Zero Rischi",
    desc:
      typeof subscriptionRaw?.desc === "string"
        ? subscriptionRaw.desc
        : "Gestiamo verifiche, scadenze e fornitori con un'unica regia – così sai sempre a che punto sei.",
    bullets: Array.isArray(subscriptionRaw?.bullets)
    ? subscriptionRaw.bullets.filter((item: unknown): item is string => typeof item === "string")
    : [
          "Piano completo di verifiche con scadenze chiare",
          "Reminder automatici e coordinamento con gli enti",
          "Report periodici sullo stato di conformità",
          "Supporto in caso di controlli ispettivi",
          "Servizi specialistici attivabili quando servono"
        ],
    cta:
      typeof subscriptionRaw?.cta === "string"
        ? subscriptionRaw.cta
        : "Richiedi una proposta di abbonamento"
  };

  const promiseRaw = t("promise") as any;
  const promise: PromiseContent = {
    eyebrow: typeof promiseRaw?.eyebrow === "string" ? promiseRaw.eyebrow : "Impegno Cerberus",
    title: typeof promiseRaw?.title === "string" ? promiseRaw.title : "La nostra promessa",
    bulletTitle:
      typeof promiseRaw?.bulletTitle === "string"
        ? promiseRaw.bulletTitle
        : "Cosa significa in pratica",
    paragraphs: Array.isArray(promiseRaw?.paragraphs)
      ? promiseRaw.paragraphs.filter((item: unknown): item is string => typeof item === "string")
      : [
          "Non possiamo prometterti che non avrai mai un controllo. Possiamo però dirti con trasparenza dove sei scoperto, quali sono le priorità e cosa conviene fare subito.",
          "Ti accompagniamo nella preparazione dei documenti, nelle risposte agli enti e nelle azioni correttive: quando arriva un'ispezione non resti solo."
        ],
    bullets: Array.isArray(promiseRaw?.bullets)
      ? promiseRaw.bullets.filter((item: unknown): item is string => typeof item === "string")
      : [
          "Consigli pratici, non burocrazia",
          "Controllo costante dello stato di conformità",
          "Affiancamento diretto durante gli audit"
        ]
  };

  const resourcesRaw = t("resourcesSection") as any;
  const finalCtaRaw = t("finalCta") as any;

  const fallbackLeadFields: LeadField[] = [
    { name: "firstName", label: "Nome" },
    { name: "lastName", label: "Cognome" },
    { name: "email", label: "Email", type: "email" },
    { name: "company", label: "Azienda" },
    { name: "role", label: "Ruolo", fullWidth: true }
  ];

  const fallbackPosts: ResourceArticle[] = [
    {
      title: "Come prepararsi a una verifica INAIL senza stress",
      href: "/blog/prepararsi-verifica-inail",
      category: "Normativa",
      excerpt: "Documenti da avere pronti e passaggi chiave prima di un controllo."
    },
    {
      title: "DPR 462/01: checklist operativa per gli impianti di messa a terra",
      href: "/blog/dpr-462-checklist",
      category: "Impianti",
      excerpt: "Gli step indispensabili per prevenire contestazioni e fermo impianto."
    },
    {
      title: "Verifiche sulle attrezzature in pressione: cosa cambia nel 2025",
      href: "/blog/verifiche-pressione-2025",
      category: "Aggiornamenti",
      excerpt: "Le novità normative e come organizzare scadenze e responsabilità."
    }
  ];

  const resources: ResourcesContent = {
    eyebrow:
      typeof resourcesRaw?.eyebrow === "string"
        ? resourcesRaw.eyebrow
        : "Risorse e approfondimenti",
    title:
      typeof resourcesRaw?.title === "string"
        ? resourcesRaw.title
        : "Vuoi capire meglio cosa ti serve davvero?",
    lead:
      typeof resourcesRaw?.lead === "string"
        ? resourcesRaw.lead
        : "Scarica la checklist e leggi gli ultimi articoli per orientarti tra obblighi e ispezioni.",
    leadMagnet: {
      title:
        typeof resourcesRaw?.leadMagnet?.title === "string"
          ? resourcesRaw.leadMagnet.title
          : "Checklist Verifica Zero Rischi",
      subtitle:
        typeof resourcesRaw?.leadMagnet?.subtitle === "string"
          ? resourcesRaw.leadMagnet.subtitle
          : "Le verifiche minime che ogni datore di lavoro dovrebbe conoscere.",
      formTitle:
        typeof resourcesRaw?.leadMagnet?.formTitle === "string"
          ? resourcesRaw.leadMagnet.formTitle
          : "Compila il modulo per riceverla via email",
      privacy:
        typeof resourcesRaw?.leadMagnet?.privacy === "string"
          ? resourcesRaw.leadMagnet.privacy
          : "Confermo di voler ricevere la checklist e di aver letto l'informativa privacy.",
      cta:
        typeof resourcesRaw?.leadMagnet?.cta === "string"
          ? resourcesRaw.leadMagnet.cta
          : "Invia e ricevi la checklist",
      success:
        typeof resourcesRaw?.leadMagnet?.success === "string"
          ? resourcesRaw.leadMagnet.success
          : "Grazie! Ti invieremo la checklist via email entro poche ore.",
      fields: Array.isArray(resourcesRaw?.leadMagnet?.fields)
        ? resourcesRaw.leadMagnet.fields.filter(
            (field: any): field is LeadField =>
              field && typeof field.name === "string" && typeof field.label === "string"
          )
        : fallbackLeadFields
    },
    blog: {
      title:
        typeof resourcesRaw?.blog?.title === "string"
          ? resourcesRaw.blog.title
          : "Dal nostro blog",
      subtitle:
        typeof resourcesRaw?.blog?.subtitle === "string"
          ? resourcesRaw.blog.subtitle
          : "Approfondimenti concreti per farti arrivare pronto alle ispezioni.",
      cta:
        typeof resourcesRaw?.blog?.cta === "string"
          ? resourcesRaw.blog.cta
          : "Vai al blog",
      postLinkLabel:
        typeof resourcesRaw?.blog?.postLinkLabel === "string"
          ? resourcesRaw.blog.postLinkLabel
          : "Leggi l'articolo",
      ctaHref:
        typeof resourcesRaw?.blog?.ctaHref === "string"
          ? resourcesRaw.blog.ctaHref
          : "/blog",
      posts: Array.isArray(resourcesRaw?.blog?.posts)
        ? resourcesRaw.blog.posts.filter(
            (post: any): post is ResourceArticle =>
              post && typeof post.title === "string" && typeof post.href === "string"
          )
        : fallbackPosts
    }
  };

  const finalCta: FinalCtaContent = {
    eyebrow:
      typeof finalCtaRaw?.eyebrow === "string"
        ? finalCtaRaw.eyebrow
        : "Pronto a fare il punto?",
    title:
      typeof finalCtaRaw?.title === "string"
        ? finalCtaRaw.title
        : "Richiedi il tuo Check-up Verifica Zero Rischi",
    subtitle:
      typeof finalCtaRaw?.subtitle === "string"
        ? finalCtaRaw.subtitle
        : "Compila il form e ti ricontattiamo per una valutazione senza impegno dei tuoi impianti e attrezzature.",
    bullets: Array.isArray(finalCtaRaw?.bullets)
      ? finalCtaRaw.bullets.filter((item: unknown): item is string => typeof item === "string")
      : [
          "Analisi iniziale delle verifiche obbligatorie",
          "Piano di priorità chiaro e condiviso",
          "Affiancamento durante controlli e ispezioni"
        ],
    cta:
      typeof finalCtaRaw?.cta === "string"
        ? finalCtaRaw.cta
        : "Richiedi il Check-up",
    ctaHref:
      typeof finalCtaRaw?.ctaHref === "string"
        ? finalCtaRaw.ctaHref
        : "/contatti"
  };

  const handleLeadSubmit = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    const form = event.currentTarget;
    setLeadSuccess(true);
    form.reset();
  };

  const handleLeadChange = () => {
    if (leadSuccess) {
      setLeadSuccess(false);
    }
  };

  const resolveAutocomplete = (fieldName: string) => {
    const normalized = fieldName.toLowerCase();
    if (normalized.includes("first")) return "given-name";
    if (normalized.includes("last") || normalized.includes("surname") || normalized.includes("cognome")) {
      return "family-name";
    }
    if (normalized.includes("email")) return "email";
    if (normalized.includes("company") || normalized.includes("azienda")) return "organization";
    if (normalized.includes("role") || normalized.includes("ruolo")) return "organization-title";
    return "off";
  };

  return (
    <div className="min-h-screen">
      <Header />

      <main>
        <Hero />
        <HowItWorks />
        <section className="home-highlights fade-section">
          <div className="container">
            <div className="highlights-grid">
              <div>
                <Reveal variant="fade-up">
                  <p className="section-eyebrow">{t("home.sections.overview.eyebrow")}</p>
                  <h2 className="section-title">{t("home.introTitle")}</h2>
                  <p className="section-subtitle">{t("home.introText")}</p>
                </Reveal>
                <div className="highlight-bullets">
                  {highlightBullets.map((bullet, index) => (
                    <Reveal
                      key={bullet.title}
                      className="highlight-bullet"
                      variant="fade-up"
                      delay={index * 80}
                    >
                      <span className="highlight-bullet-index">0{index + 1}</span>
                      <div>
                        <h3>{bullet.title}</h3>
                        <p>{bullet.desc}</p>
                      </div>
                    </Reveal>
                  ))}
                </div>
              </div>

              <Reveal className="highlight-card" variant="fade-up" delay={160}>
                <div className="highlight-card-body">
                  <p className="highlight-card-eyebrow">{t("home.sections.cta.eyebrow")}</p>
                  <h3>{t("ctaBanner.title")}</h3>
                  <p>{t("ctaBanner.desc")}</p>
                  <Link href="/contatti" className="btn btn-primary highlight-card-action">
                    {t("ctaBanner.button")}
                  </Link>
                </div>
              </Reveal>
            </div>
          </div>